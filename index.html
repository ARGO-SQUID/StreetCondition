<!DOCTYPE html>
<html lang="en">
  <head profile="http://www.w3.org/2005/10/profile">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="stylesheet" href="//rawgithub.com/Caged/d3-tip/master/examples/example-styles.css">
    <link href="main.css" rel="stylesheet" type="text/css"> 
    <title>Street Map</title>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
    <script type="text/javascript" src="js/d3/d3.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" />
    <link rel="icon" type="image/png" href="./favicon.png">  
      <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script src="js/Caged-d3-tip-3aa7df4/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
   <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
   <!--<script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>-->
  </head>
  <body>
    <div id="container">
    <div id="title">Street Condition Scoring Tool</div>
    <div id='menumobile'>&#9776; </div>
    
    <div id="sidebar">
        
        <div class="dropdown">
            <button id='dd1' class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" value='Button'> All Boroughs
        <span class="caret"></span></button>
         <ul class="dropdown-menu">
             <li><a href="#">All Boroughs</a></li>
             <li><a href="#">Manhattan</a></li>
             <li><a href="#">Brooklyn</a></li>
             <li><a href="#">Bronx</a></li>
             <li><a href="#">Queens</a></li>
             <li><a href="#">Staten Island</a></li>
            </ul>
        </div>
        <div id="statistics"> 
            <p id='st1'>Census Tract <u class=stats id='ct' > Select </u> in <u class=stats id='nhood'> Select </u>, <u class=stats id='boro'>Select </u> has response score of:</p>
        </div>
        <div id="score">
            <p>Score</p>
        </div>
        <div id="sub" data-toggle="tooltip" title="(car_wt*per_capita_car)+(income_wt*median income)+(comptaint_wt*311_complain)+(SQUID_wt*SQUID_score)"><span class="glyphicon glyphicon-question-sign"></span></div>
        <h6 style="float:left"><i>Adjust Weight from 1-5 and hover over map to visualize.</i></h6>
        <div id="ranksection">
            <!--<span class="tooltiptext">Tooltip text</span>-->
            <input class='rank' id="rankcar" placeholder="1.0" onblur="checkfields(this);" data-toggle="tooltip" title="Car Weight" > 
            <input class='rank' id="rankincome"  placeholder="1.0" onchange="checkfields(this);" data-toggle="tooltip" title="Income Weight"> 
            <input class='rank' id="rankcomplaint" placeholder="1.0" onchange="checkfields(this);" data-toggle="tooltip" title="Street Complaint Weight">
            <input class='rank' id="ranksquid" placeholder="1.0" onchange="checkfields(this);" data-toggle="tooltip" title="Squid Score Weight">
            <button id='update' value="Update">Go<span  class="glyphicon glyphicon-menu-right"></span></button> 
        <div style="float:left;width:100%;">
            <p class='textboxlabels'>Car Ownership&nbsp;&nbsp;&nbsp;Median Income &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;311 Model
                &nbsp;&nbsp;&nbsp;&nbsp;SQUID Score</p>
            
        </div>
        </div>
        <!--
        <button id='updatemap' type="button" data-toggle="tooltip" title="Update Map to current seetings" >Update Map
        <span class="glyphicon glyphicon-play-circle"></span>  </button>   --> 
        <script>
            $('#update').on('click',function()
                            {
                wtcar = $('#rankcar').val();
                wtincome = $("#rankincome").val();
                wtstreet = $("#rankcomplaint").val();
                wtsquid= $("#ranksquid").val();
                //weights();
                  if(wtcar==''){
                    wtcar=1;
                }
                else if(wtcar>5 || wtcar<0){
                    $('#rankcar').effect("shake");
                    $('#rankcar').val('');
                    wtcar=1;
                }
                if(wtincome==''){
                    wtincome=1;
                }
                else if(wtincome>5 || wtincome<0){
                    $('#rankincome').effect("shake");
                    $('#rankincome').val('');
                    wtincome=1;
                }
                if(wtstreet==''){
                    wtstreet=1;
                }
                else if(wtstreet>5 || wtstreet<0){
                    $('#rankcomplaint').effect("shake");
                    $('#rankcomplaint').val('');
                    wtstreet=1;
                }
                if(wtsquid==''){
                    wtsquid=1;
                }
                else if(wtsquid>5 || wtsquid<0){
                    $('#ranksquid').effect("shake");
                    $('#ranksquid').val('');
                    wtsquid=1;
                }
                compliants(wtcar,wtincome,wtstreet,wtsquid,maxyear,minyear,bname,[minscore,maxscore])
                map.removeLayer(geojson);
                readdata();
            });
        </script> 
        <script>
            $(document).ready(function(){
                $('[data-toggle="tooltip"]').tooltip();
            });
        </script>
       
        <div id='rankall'>
            <p id="rankicon1"> Top Ranked </p>
             <span id="rankicon" class="glyphicon">&#xe155;</span><br><br>
            <div class="barchartcontainer"><svg id="svg4"></svg></div>
            
        </div>
          
        
      </div>
        
      <div id="map">
          <div id=inspector>
          <div class="slider">
         <p>
             <label for="amount">Year range:</label>
             <input type="text" id="amount" readonly style="border:0; color:black; font-weight:bold; margin-top:10">
        </p>
        <div id="slider-range" style="width:92%"></div><br>
        </div>
        <div class="slider">
         <p>
             <label for="amount1" >Score range:</label>
             <input type="text" id="amount1" readonly style="border:0; color:black; font-weight:bold; margin-top:10">
        </p>
        <div id="slider-score" style="width:90%"></div><br>
        </div>
        <div id='insp_button_div'>
            <button id='inspector_update'>Update Map</button>
        </div>
            
           <script>
            var minyear = 2005;
            var maxyear = 2016;
            var minscore=0;
            var maxscore=100;
            var maxscore_default=2085;
            var k='All Boroughs';
            var wtcar = 1;
            var wtincome = 1;
            var wtstreet = 1;
            var wtsquid = 1;
            var year = function(min,max,defm,defmax,v,a) {
            
                $( "#slider-"+v ).slider({
                  range: true,
                  min: min,
                  max: max,
                  values: [ defm, defmax ],
                  slide: function( event, ui ) {
                    
                    
                    $( "#"+a ).val( ui.values[ 0 ] + " - " + ui.values[ 1 ] );
                    minyear=+($('#amount').val().split('-')[0].trim());
                    maxyear=+($('#amount').val().split('-')[1].trim());
                    minscore=+($('#amount1').val().split('-')[0].trim());
                    maxscore=+($('#amount1').val().split('-')[1].trim());
                    //console.log(wtcar,wtincome,wtstreet);
                     
                    
                  }
                });
                var y=$('#amount').val();
                $( "#"+a ).val( "" + $( "#slider-"+v ).slider( "values", 0 ) +
                  " - " + $( "#slider-"+v ).slider( "values", 1 ) );
              };
             //console.log(maxscore)
             year(2005,2016,2005,2016,'range','amount');
             year(0,100,0,100,'score','amount1');
              $('#inspector_update').on('click',function(){
                          compliants(wtcar,wtincome,wtstreet,wtsquid,maxyear,minyear,bname,[minscore,maxscore]);
                           map.removeLayer(geojson);
                           readdata();    
                      })
              
               function checkfields(sel){
            
                if($('#'+sel.id).val()>5 || $('#'+sel.id).val()<0){
                    $('#'+sel.id).effect("shake");
                    $('#'+sel.id).val('');
                   // compliants(1,1,1,maxyear,minyear,bname,[minscore,maxscore]);
                }
            }
               
        </script>
          </div>
      </div>

    </div><!-- /.container -->

    
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script>
   
    //console.log($( "#slider-range" ).slider( "values", 0 ),$( "#slider-range" ).slider( "values", 1 ));
   
    var queue =[-19];
    var minqueue =[2];
    var maxqueue =[2];
    var map = L.map('map', {
   
        scrollWheelZoom: false
      }).setView( [40.727802,-73.893266], 11);



      var geojson;
  

      //this function takes a value and returns a color based on which bucket the value falls between
      function getColor(d) {
          
          return d > 90  ? '#FC4E2A' :
                 d > 60   ? '#FD8D3C' :
                 d > 40   ? '#FEB24C' :
                 d > 20   ? '#FED976' :
                            '#FFEDA0';
      }
   

    L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>,Developed by:<a href="http://nikhilsprofile.com">Nikhil Kishore</a>'
    }).addTo(map);
    map.doubleClickZoom.disable(); 

    var layerUrl = 'https://rgdonohue.cartodb.com/api/v2/viz/bcdbfe36-6f4f-11e5-833d-0e674067d321/viz.json';

    cartodb.createLayer(map, layerUrl,{
        legends:false
    })
      .addTo(map)
      .on('done', function(layer) {

      }).on('error', function() {
        //log the error
      });

      function style(feature) {
          streetcol=0
          //console.log(maxyear,minyear);
            if((maxyear-minyear)!=11)
                    {
                        for(i=minyear;i<=maxyear;i++){
                        streetcol+=parseInt(feature.properties['rstreet'+i]);
                    }
                   // console.log(maxyear-minyear)
                    streetcol=streetcol/(maxyear-minyear);
                    }
                else{
                    streetcol=parseInt(feature.properties['rstreet']);
                }
          scorec=(wtcar*feature.properties['rveh'])+(wtincome*(2159-(feature.properties['rincome'])))+(wtstreet*streetcol)+(wtsquid*feature.properties['squid']);
          scorec=Math.ceil(((scorec/maxscore_default)*100)/4)
          console.log('Income: ',wtincome," 311:",wtstreet);
          if(feature.properties.BoroName==k || k=='All Boroughs' && scorec<=maxscore && scorec>=minscore){
              
              return {
                  fillColor: getColor(scorec),
                  weight: 0.5,
                  opacity: 1,
                  color: 'white',
                  dashArray: '1',
                  fillOpacity: 0.8
              };
          }
          else{
               return {
                  fillColor: getColor(scorec),
                  weight: 0.5,
                  opacity: 1,
                  color: 'white',
                  dashArray: '1',
                  fillOpacity: 0.05
              };
          }
         
        }
        

        //this function is set to run when a user mouses over any polygon
        var bname='All Boroughs';
        var score = 'All';
        function mouseoverFunction(e) {
          var layer = e.target;
            //console.log(layer)
          layer.setStyle({
              weight: 5,
              color: '#666',
              dashArray: '',
              fillOpacity: 0.7
          });
            
            minyear = parseInt($('#amount').val().split('-')[0].trim());
            maxyear = parseInt($('#amount').val().split('-')[1].trim());
            //console.log(min,max);
            total=0
            for(i=minyear;i<=maxyear;i++){
                //console.log(i);
                total+=layer.feature.properties[i+'_1'];
            }
            //console.log(layer.feature.properties['Total']);
            //document.getElementById("requests").innerHTML=total;
            document.getElementById("ct").innerHTML=layer.feature.properties['BoroCT2010'].toString().slice(6,9);
            document.getElementById("nhood").innerHTML=layer.feature.properties['NTAName'];
            document.getElementById("boro").innerHTML=layer.feature.properties['BoroName'];
          
            weights = function(){
                var car = parseInt(layer.feature.properties['rveh']);
                var income=parseInt(layer.feature.properties['rincome']);
                var squid=parseInt(layer.feature.properties['squid']);
                var street=0
                // if min and max year is custom selected then mean of selected year's rank is returned as effective net complaint rank
                if((maxyear-minyear)!=11)
                    {
                        for(i=minyear;i<=maxyear;i++){
                        street+=parseInt(layer.feature.properties['rstreet'+i]);
                    }
                   // console.log(maxyear-minyear)
                    street=street/(maxyear-minyear);
                    }
                else{
                    street=parseInt(layer.feature.properties['rstreet']);
                }
                //console.log(street,'street');
                wtcar = $('#rankcar').val();
                wtincome = $("#rankincome").val();
                wtstreet = $("#rankcomplaint").val();
                wtsquid= $("#ranksquid").val();
                if(wtcar==''){
                    wtcar=1;
                }
                else if(wtcar>5 || wtcar<0){
                   // $('#rankcar').effect("shake");
                //    $('#rankcar').val('');
                    wtcar=1;
                }
                if(wtincome==''){
                    wtincome=1;
                }
                else if(wtincome>5 || wtincome<0){
                    //$('#rankincome').effect("shake");
                    //$('#rankincome').val('');
                    wtincome=1;
                }
                if(wtstreet==''){
                    wtstreet=1;
                }
                else if(wtstreet>5 || wtstreet<0){
                    //$('#rankcomplaint').effect("shake");
                    //$('#rankcomplaint').val('');
                    wtstreet=1;
                }
                if(wtsquid==''){
                    wtsquid=1;
                }
                else if(wtsquid>5 || wtsquid<0){
                   // $('#ranksquid').effect("shake");
                    //$('#ranksquid').val('');
                    wtsquid=1;
                }
                score= (wtcar*car)+(wtincome*(2159-income))+(wtstreet*street)+(wtsquid*squid);
                //console.log(score);
            
                sumwts=wtcar+wtincome+wtstreet+wtsquid;
                //console.log(sumwts);
                //if weights are changed then queue will update maps and top census tracts
               // queue.push(sumwts);
                //if yearrange is changed then minqueue and maxqueus would track changes and update top census tracts.  
            
                //console.log(queue, queue.length)
              
                //console.log(maxscore_default)
                document.getElementById("score").innerHTML=Math.ceil(((score/maxscore_default)*100)/4)
              
                
                //console.log(rankcar);
            }
            weights();
            

          if (!L.Browser.ie && !L.Browser.opera) {
              layer.bringToFront();
          }

          //update the text in the infowindow with whatever was in the data
         // console.log(layer.feature.properties.NTACode+ '\n\n'+ layer.feature.properties.NoiseComplains);
          //$('#infoWindow').text(layer.feature.properties.NTACode+'\n\n'+ layer.feature.properties.NoiseComplains);
        }
        
        var currclick=[];
        var currids=[];
        function mouseclickFunction(e){
            
            var layer = e.target;
            currclick.push(layer);
            currids.push(this._leaflet_id)
            //console.log(layer)
            layer.removeEventListener('mouseout',false);
            layer.removeEventListener('mouseover',false);
            //document.getElementById("score").removeEventListener("mousemove");
            console.log(currids);
            if(currclick.length>1){
                if(currids[0]==currids[1]){
                   // console.log(currids);
                    geojson.resetStyle(currclick[0]);
                    currclick[0].addEventListener('mouseout',resetHighlight);
                    currclick[0].addEventListener('mouseover',mouseoverFunction);
                    currclick=[]
                    currids=[]
                }
                else
                {
                 geojson.resetStyle(currclick[0]);
                currclick[0].addEventListener('mouseout',resetHighlight);
                currclick[0].addEventListener('mouseover',mouseoverFunction);
                 currclick.shift();
                currids.shift();
                }
            }
            if(currids[0]!=currids[1]){
            layer.setStyle({
              fillColor:Randomcolor(),
              weight: 1,
              color: '#666',
              dashArray: '',
              fillOpacity: 0.7
                
          });
               // if(currids.length!=0)
                weights();
            }
       
            
        }

        //this runs on mouseout
        function resetHighlight(e) {
          geojson.resetStyle(e.target);
            //var layer = e.target;
            //document.getElementById("requests").innerHTML=0
            document.getElementById("ct").innerHTML="Select"
            document.getElementById("nhood").innerHTML="Select"
            document.getElementById("boro").innerHTML="Select"
            document.getElementById("score").innerHTML="Select"
        }
        
        var info = L.control();

        info.setPosition("topright");
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;
        };

        // method that we will use to update the control based on feature properties passed
        info.update = function (props) {
            this._div.innerHTML = '<h5>Last updated: 2016-10-18</h5>'+'<h5>Total 311 requests: <b>607875</b></h5>'+'<h5><a href="https://github.com/nk1877/StreetCondition/blob/master/GettingCoordinates_Step2.ipynb">71663</a> of requests<br>programmatically geocoded '+'</h5>';
        };
        info.addTo(map);
        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function (map) {

        var div = L.DomUtil.create('div', 'info legend'),
        grades = [0,20,40,60,90],
        labels = [];

    // loop through our density intervals and generate a label with a colored square for each interval
        div.innerHTML='<h4>Score Quartiles</h4>'
        for (var i = 0; i < grades.length; i++) {
        div.innerHTML +='<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
            grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
        }

        return div;
    };

    legend.addTo(map);

      function onEachFeature(feature, layer) {
           //console.log(layer.feature.properties.BoroName)
        if(layer.feature.properties.BoroName==k || k=='All Boroughs' ){
         layer.on({
             mouseover: mouseoverFunction,
             mouseout: resetHighlight,
             click: mouseclickFunction
         });
        };
       }

      var readdata=function(){
      $.getJSON('data/master.geojson', function(state_data) {
        //console.log(state_data);
         
         geojson = L.geoJson(state_data,{
            style: style,
            onEachFeature: onEachFeature
          }).addTo(map);
      });
      };
        readdata();
  
    $('.dropdown-menu li a').on('click', function(){
        if(k!=$(this).html()){
        map.removeLayer(geojson);
        //console.log(($(this).html()));
       // console.log(minyear,maxyear)
        bname=$(this).html();
        document.getElementById('dd1').innerHTML=bname
        //console.log(minyear,maxyear)
        year(0,100,0,100,'score','amount1');
        minscore=0;
        maxscore=100;
        if(minscore==''){
            compliants(wtcar,wtincome,wtstreet,wtsquid,maxyear,minyear,bname);
        }
        else{
               compliants(wtcar,wtincome,wtstreet,wtsquid,maxyear,minyear,bname,[minscore,maxscore]); 
            }
        k=($(this).html());
        readdata();}
    });
        //readdata();
    </script>
       <script type="text/javascript" src="js/topten.js"> </script>
       <script>initbar();</script>
      <script>compliants(1,1,1,1,2016,2005);</script>
      <script>
          console.log("Hi, I am Nikhil, Developer of the webtool");
          console.log("More information about men availabe at http://www.nikhilsprofile.com/")
      </script>
      <script>
        var toggle=0;
        $('#menumobile').click(function(){
            if(toggle==0){
                $('#sidebar').css('display','block');
                toggle=1;
            }
            else{
                $('#sidebar').css('display','none');
                toggle=0;
            }
        })
        
        </script>
  </body>
</html>
